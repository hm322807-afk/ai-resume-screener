<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Dashboard - AI Resume Screener</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-gradient">Candidate Ranking</h1>
            <div class="text-center">
                <a href="/" class="btn btn-secondary mb-4">‚Üê Analyze New Batch</a>
            </div>
        </header>

        <!-- Visualization Grid -->
        <div class="grid grid-cols-2 mb-8">
            <section class="card">
                <h3 class="mb-4">Top Candidates</h3>
                <canvas id="rankingChart"></canvas>
            </section>
            <section class="card">
                <h3 class="mb-4">Category Breakdown</h3>
                <canvas id="radarChart"></canvas>
            </section>
        </div>

        <!-- Ranking Table -->
        <main class="card">
            <div class="mb-8"
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <h2>Leaderboard</h2>
                <button onclick="exportToCSV()" class="btn btn-secondary">‚¨á Export Results</button>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Candidate</th>
                            <th>Match %</th>
                            <th>AI Summary</th>
                            <th>Categories</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for res in results %}
                        <tr>
                            <td><strong>#{{ loop.index }}</strong></td>
                            <td>
                                <div><strong>{{ res.filename }}</strong></div>
                                <div class="badge badge-{{ res.rec_class }}"
                                    style="margin-top: 0.5rem; display: inline-block;">
                                    {{ res.recommendation }}
                                </div>
                            </td>
                            <td>
                                <div class="badge badge-{{ res.rec_class }}" style="font-size: 1.125rem;">
                                    {{ res.final_score }}%
                                </div>
                            </td>
                            <td style="max-width: 320px; font-size: 0.875rem; color: var(--text-muted);">
                                {{ res.ai_feedback }}
                            </td>
                            <td>
                                <div style="font-size: 0.75rem; display: grid; gap: 0.25rem;">
                                    <div>üíª Tech: {{ res.category_scores['Technical'] }}%</div>
                                    <div>üó£ Soft: {{ res.category_scores['Soft Skills'] }}%</div>
                                    <div>üìÖ Exp: {{ res.category_scores['Experience'] }}%</div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // Data Injection from Flask/Jinja
        const resultsData = {{ results | tojson }};

        // Chart Defaults for Dark Mode
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';

        // 1. Bar Chart (Ranking)
        if (resultsData && resultsData.length > 0) {
            const ctxBar = document.getElementById('rankingChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: resultsData.map(r => r.filename),
                    datasets: [{
                        label: 'Match %',
                        data: resultsData.map(r => r.final_score),
                        backgroundColor: '#818cf8',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            // 2. Radar Chart (Top Candidate)
            const topRes = resultsData[0];
            const ctxRadar = document.getElementById('radarChart').getContext('2d');
            new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['Technical', 'Soft Skills', 'Experience'],
                    datasets: [{
                        label: topRes.filename,
                        data: [
                            topRes.category_scores['Technical'],
                            topRes.category_scores['Soft Skills'],
                            topRes.category_scores['Experience']
                        ],
                        backgroundColor: 'rgba(244, 114, 182, 0.2)',
                        borderColor: '#f472b6',
                        pointBackgroundColor: '#f472b6'
                    }]
                },
                options: {
                    scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }
                }
            });
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Rank,Filename,Score,Recommendation,Feedback,Technical,SoftSkills,Experience\n";
            resultsData.forEach((res, index) => {
                csvContent += `${index + 1},"${res.filename}",${res.final_score},${res.recommendation},"${res.ai_feedback}",${res.category_scores['Technical']},${res.category_scores['Soft Skills']},${res.category_scores['Experience']}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "ai_resume_ranking.csv";
            link.click();
        }
    </script>
</body>

</html>